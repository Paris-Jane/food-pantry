<!--Paris Ward, Lucas Moraes, Parker Sandstrom, and Joshua Ethington-->
<!--This page will display the databases-->
<!--It will display a customer info, employee info and order page.-->
<!--It will allow user to do CRUD capabilities depending on permissions-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utah Food Bank Tracker - Database</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo"><a href="/">Utah Food Bank Tracker</a></div>
        <nav class="nav">
            <% if (user && user.role === 'Manager') { %>
            <a href="/addEmp">Add Employee</a>
            <% } %>
            <a href="/logout">Logout</a>
        </nav>
    </header>

    <!-- Main Container -->
    <div class="container">
        <div class="page-header">
            <h1 class="title">Database Management</h1>
            <p class="page-subtitle">View and manage customer, employee, and order information</p>
            <p><%=error_message%></p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <% const tables = ['customers', 'employees', 'orders']; %>
            <% tables.forEach(tab => { %>
                <div class="tab <%= currentTable === tab ? 'active' : '' %>"
                    onclick="window.location.href='/database?table=<%= tab %>'">
                    <%= tab %>
                </div>
            <% }) %>
        </div>

        <!-- Search Bar -->
        <form class="search-bar" method="GET" action="/database" id="search-form">
            <input type="hidden" name="table" value="<%= currentTable %>">
            <input type="hidden" name="sortColumn" id="sortColumn" value="<%= currentSortColumn || '' %>">
            <input type="hidden" name="sortOrder" id="sortOrder" value="<%= currentSortOrder || 'asc' %>">
            
            <div class="search-group">
                <input type="text" name="search" placeholder="Search <%= currentTable %>..." value="<%= searchTerm || '' %>">
                <select name="col" id="search-options">
                    <% if (records.length > 0) { %>
                        <% Object.keys(records[0]).forEach(column => { %>
                            <option value="<%= column %>" <%= col === column ? 'selected' : '' %>><%= column %></option>
                        <% }) %>
                    <% } %>
                </select>
            </div>

            <div class="action-buttons">
                <button type="submit">Search</button>
                <% if (user && user.role === 'Manager') { %>
                    <a href="/add/<%=currentTable%>" class="btn-add">Add New</a>
                <% } %>
            </div>
        </form>

        <% if (user && user.role === 'Manager') { %>
        <!-- Bulk actions (shown only when checkboxes selected) -->
        <div class="bulk-actions" id="bulk-actions">
            <span id="selected-count">0 selected</span>
            <div class="bulk-actions-buttons">
                <button type="button" class="bulk-edit" id="bulk-edit-btn">Edit Selected</button>
                <button type="button" class="bulk-delete" id="bulk-delete-btn">Delete Selected</button>
            </div>
        </div>
        <% } %>

        <!-- Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <% if (records.length > 0) { %>
                            <% if (user && user.role === 'Manager') { %>
                                <th class="select-cell">
                                    <!-- Select all checkbox -->
                                    <input type="checkbox" id="select-all">
                                </th>
                            <% } %>
                            <% Object.keys(records[0]).forEach(key => { %>
                                <th class="sortable" data-column="<%= key %>">
                                    <span><%= key %></span>
                                    <span class="sort-icon">⇅</span>
                                </th>
                            <% }) %>
                        <% } else { %>
                            <th>No records found</th>
                        <% } %>
                    </tr>
                </thead>

                <tbody>
                    <!--Figure out which "id" column you will need to pass along-->
                    <% let idColumn;
                        if (currentTable === 'employees') {
                        idColumn = 'employee_id';
                        } else if (currentTable === 'orders') {
                        idColumn = 'order_id';
                        } else {
                        idColumn = 'customer_id';
                        }%>

                    <% if (records.length > 0) { %>
                        <% records.forEach(record => { %>
                            <tr>
                                <% if (user && user.role === 'Manager') { %>
                                    <td class="select-cell">
                                        <input type="checkbox"
                                            class="row-select"
                                            value="<%= record[idColumn] %>">
                                    </td>
                                <% } %>

                                <% Object.values(record).forEach(value => { %>
                                    <td><%= value %></td>
                                <% }) %>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="100" class="no-records">
                                No <%= currentTable %> found. Try adjusting your search.
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <% if (user && user.role === 'Manager') { %>
    <!-- Delete confirmation popup INSIDE the page -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal">
            <h2>Confirm Delete</h2>
            <p id="delete-modal-text">
                Are you sure you would like to delete the selected user(s)?
            </p>
            <div class="modal-actions">
                <button type="button" class="modal-btn-cancel" id="modal-cancel-btn">Cancel</button>
                <button type="button" class="modal-btn-confirm" id="modal-confirm-btn">Delete</button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const tableName = "<%= currentTable %>";
            const bulkBar = document.getElementById("bulk-actions");
            const editBtn = document.getElementById("bulk-edit-btn");
            const deleteBtn = document.getElementById("bulk-delete-btn");
            const selectedCountSpan = document.getElementById("selected-count");
            const checkboxes = document.querySelectorAll(".row-select");
            const selectAll = document.getElementById("select-all");

            // Modal elements
            const modalOverlay = document.getElementById("delete-modal");
            const modalText = document.getElementById("delete-modal-text");
            const modalCancel = document.getElementById("modal-cancel-btn");
            const modalConfirm = document.getElementById("modal-confirm-btn");

            let pendingDeleteIds = [];

            function getSelectedIds() {
                return Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
            }

            function toggleRowSelected(checkbox) {
                const row = checkbox.closest("tr");
                if (!row) return;
                if (checkbox.checked) {
                    row.classList.add("row-selected");
                } else {
                    row.classList.remove("row-selected");
                }
            }

            function updateSelectAllState() {
                if (!selectAll) return;
                const total = checkboxes.length;
                const selected = getSelectedIds().length;

                if (selected === 0) {
                    selectAll.checked = false;
                    selectAll.indeterminate = false;
                } else if (selected === total) {
                    selectAll.checked = true;
                    selectAll.indeterminate = false;
                } else {
                    selectAll.checked = false;
                    selectAll.indeterminate = true;
                }
            }

            function updateBulkUI() {
                const ids = getSelectedIds();
                const count = ids.length;

                if (count === 0) {
                    bulkBar.style.display = "none";
                } else {
                    bulkBar.style.display = "flex";
                    selectedCountSpan.textContent = count + " selected";
                }

                if (count === 1) {
                    editBtn.style.display = "inline-block";
                } else {
                    editBtn.style.display = "none";
                }

                updateSelectAllState();
            }

            // Individual checkbox changes
            checkboxes.forEach(cb => {
                cb.addEventListener("change", function () {
                    toggleRowSelected(this);
                    updateBulkUI();
                });
            });

            // Select all checkbox
            if (selectAll) {
                selectAll.addEventListener("change", function () {
                    const checked = this.checked;
                    checkboxes.forEach(cb => {
                        cb.checked = checked;
                        toggleRowSelected(cb);
                    });
                    updateBulkUI();
                });
            }

            if (editBtn) {
                editBtn.addEventListener("click", function () {
                    const ids = getSelectedIds();
                    if (ids.length !== 1) return;
                    const id = encodeURIComponent(ids[0]);
                    window.location.href = `/edit/${tableName}/${id}`;
                });
            }

            if (deleteBtn) {
                deleteBtn.addEventListener("click", function () {
                    const ids = getSelectedIds();
                    if (ids.length === 0) return;

                    pendingDeleteIds = ids;

                    // Update modal message with count
                    if (ids.length === 1) {
                        modalText.textContent = "Are you sure you would like to delete this record? This action cannot be undone.";
                    } else {
                        modalText.textContent = `Are you sure you would like to delete these ${ids.length} records? This action cannot be undone.`;
                    }

                    // Show popup
                    modalOverlay.style.display = "flex";
                });
            }

            // Modal buttons
            if (modalCancel) {
                modalCancel.addEventListener("click", function () {
                    // Close popup, do nothing
                    modalOverlay.style.display = "none";
                    pendingDeleteIds = [];
                });
            }

            if (modalConfirm) {
                modalConfirm.addEventListener("click", async function () {
                    if (!pendingDeleteIds || pendingDeleteIds.length === 0) {
                        modalOverlay.style.display = "none";
                        return;
                    }

                    try {
                        await Promise.all(
                            pendingDeleteIds.map(id =>
                                fetch(`/delete/${tableName}/${encodeURIComponent(id)}`, {
                                    method: "POST"
                                })
                            )
                        );
                        // Hide popup and reload to reflect changes
                        modalOverlay.style.display = "none";
                        window.location.reload();
                    } catch (err) {
                        console.error("Error deleting records", err);
                        alert("There was an error deleting records. Please try again.");
                        modalOverlay.style.display = "none";
                    }
                });
            }

            // Close modal when clicking outside
            modalOverlay.addEventListener("click", function(e) {
                if (e.target === modalOverlay) {
                    modalOverlay.style.display = "none";
                    pendingDeleteIds = [];
                }
            });

            // Sorting
            let currentSortColumn = "<%= currentSortColumn || '' %>";
            let currentSortOrder = "<%= currentSortOrder || 'asc' %>";
            const sortIcons = document.querySelectorAll('.sort-icon');
            const sortableHeaders = document.querySelectorAll('.sortable');
            const searchForm = document.getElementById('search-form');

            function updateSortIcons(column, order) {
                sortIcons.forEach(icon => {
                    icon.textContent = '⇅';
                    icon.classList.remove('sort-active');
                });
                const activeHeader = document.querySelector(`th[data-column="${column}"] .sort-icon`);
                if (activeHeader) {
                    activeHeader.classList.add('sort-active');
                    activeHeader.textContent = order === 'asc' ? '↑' : '↓';
                }
            }

            if (currentSortColumn) {
                updateSortIcons(currentSortColumn, currentSortOrder);
            }

            sortableHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-column');
                    let order = 'asc';
                    if (column === currentSortColumn) {
                        order = currentSortOrder === 'asc' ? 'desc' : 'asc';
                    }
                    document.getElementById('sortColumn').value = column;
                    document.getElementById('sortOrder').value = order;
                    searchForm.submit();
                });
            });
        })();
    </script>
    <% } %>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3 class="footer-title">
                        <i class="fas fa-hands-helping"></i>
                        Utah Food Bank Tracker
                    </h3>
                    <p class="footer-text">
                        Dedicated to serving our community with dignity and compassion. 
                        Together, we can make a difference.
                    </p>
                </div>
                
                <div class="footer-section">
                    <h4 class="footer-heading">Quick Links</h4>
                    <ul class="footer-links">
                        <li><a href="/home">About Us</a></li>
                        <li><a href="/login">Employee Login</a></li>
                        <li><a href="/signUp">Recipient Signup</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4 class="footer-heading">Resources</h4>
                    <ul class="footer-links">
                        <li><a href="https://secure.utahfoodbank.org/site/Donation2?df_id=2660&2660.donation=form1&chosen=50">Make a Donation</a></li>
                        <li><a href="https://www.utahfoodbank.org/give/give-time/individual-or-group-volunteering/">Volunteer</a></li>
                        <li><a href="https://www.utahfoodbank.org/about/">Our Programs</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2024 Utah Food Bank Tracker. All rights reserved.</p>
                <p class="footer-credits">
                    Developed by Paris Ward, Lucas Moraes, Parker Sandstrom, and Joshua Ethington
                </p>
            </div>
        </div>
    </footer>
</body>
</html>
